<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Naveen Wilson Team - Employee Directory</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f9f9f9; }
    nav { background-color: #003366; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
    nav h1 { margin: 0; font-size: 24px; }
    .nav-links a { color: #fff; margin-left: 20px; text-decoration: none; font-weight: 500; }
    main { padding: 30px; }
    h2 { text-align: center; font-size: 24px; color: #003366; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #005799; color: white; }
    .name-link { cursor: pointer; color: #005799; font-weight: bold; }
    .name-link:hover { text-decoration: underline; }
    .tab-buttons { display: flex; gap: 10px; margin: 10px 0; }
    .tab-button { padding: 10px 20px; background: #eee; border: none; cursor: pointer; }
    .tab-button.active { background: #005799; color: #fff; }
    .tab-content { display: none; margin-top: 10px; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <nav>
    <h1>Xencia Technology Solutions Pvt. Ltd</h1>
    <div class="nav-links">
      <a href="/naveen_logout">üîí Logout</a>
      <a href="/">üè† Home</a>
    </div>
  </nav>
  <main>
    <h2>üßë‚Äçüíº Naveen Wilson Team - Employee Directory</h2>
    <div id="naveenFullDataContainer"></div>
    <div id="detailsSection"></div>
  </main>

  <script>
    async function checkAuth() {
      const res = await fetch("/api/employees/naveen");
      if (res.status === 401) {
        window.location.href = "/naveen_login";
        return false;
      }
      return true;
    }

    async function loadTeamData() {
      if (!await checkAuth()) return;
      const res = await fetch("/api/employees/naveen");
      const team = await res.json();
      displayMembersTable(team);
    }

    function displayMembersTable(members) {
      const container = document.getElementById("naveenFullDataContainer");
      container.innerHTML = "";
      const table = document.createElement("table");
      const headers = ["EmpID", "Name", "Designation", "Email", "Phone", "Team"];
      const thead = document.createElement("thead");
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      members.forEach(member => {
        const row = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          if (h === "Name") {
            const span = document.createElement("span");
            span.className = "name-link";
            span.textContent = member[h];
            span.onclick = () => showDetails(member);
            td.appendChild(span);
          } else {
            td.textContent = member[h] || "";
          }
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function showDetails(member) {
      const section = document.getElementById("detailsSection");
      section.innerHTML = "";

      const table = document.createElement("table");
      const tr = document.createElement("tr");
      ["EmpID", "Name", "Designation", "Email", "Phone", "Team"].forEach(key => {
        const td = document.createElement("td");
        if (key === "Name") {
          td.innerHTML = `<strong>${key}:</strong> <span class="name-link">${member[key]}</span>`;
          td.querySelector("span").onclick = () => createTabs(member);
        } else {
          td.innerHTML = `<strong>${key}:</strong> ${member[key] || ""}`;
        }
        tr.appendChild(td);
      });
      table.appendChild(tr);
      section.appendChild(table);
    }

    function createTabs(member) {
      const employeeName = member.Name;
      const empId = member.EmpID;

      document.querySelectorAll(".tabs").forEach(tab => tab.remove());

      const container = document.getElementById("detailsSection");
      const tabBox = document.createElement("div");
      tabBox.className = "tabs";

      const btnGroup = document.createElement("div");
      btnGroup.className = "tab-buttons";

      const tabs = { Certificates: document.createElement("div"), Leaves: document.createElement("div"), SOPs: document.createElement("div") };

      Object.keys(tabs).forEach((tabName, i) => {
        const btn = document.createElement("button");
        btn.className = "tab-button" + (i === 0 ? " active" : "");
        btn.innerText = tabName;
        btn.onclick = () => switchTab(tabName, tabs);
        btnGroup.appendChild(btn);

        tabs[tabName].className = "tab-content" + (i === 0 ? " active" : "");
        tabs[tabName].innerHTML = `<p>Loading ${tabName}...</p>`;
      });

      tabBox.appendChild(btnGroup);
      Object.values(tabs).forEach(div => tabBox.appendChild(div));
      container.appendChild(tabBox);

      loadCertificateDataForUser(tabs.Certificates, employeeName, empId);
    }

    async function loadCertificateDataForUser(container, employeeName, empId) {
      try {
        const res = await fetch("/api/certifications/naveen");
        const data = await res.json();
        const certs = data.filter(c => c.EmpID?.toLowerCase() === empId.toLowerCase());

        if (!certs.length) {
          container.innerHTML = `<p>No certificate data found for <strong>${employeeName}</strong>.</p>`;
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tr = document.createElement("tr");
        ["EmpID", "Name", "Certificate", "Status", "ExpireDate", "MailID", "MS_Link_To_Renew_Cert"].forEach(h => {
          const th = document.createElement("th");
          th.innerText = h;
          tr.appendChild(th);
        });
        thead.appendChild(tr);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        certs.forEach(cert => {
          const row = document.createElement("tr");
          ["EmpID", "Name", "Certificate", "Status", "ExpireDate", "MailID", "MS_Link_To_Renew_Cert"].forEach(key => {
            const td = document.createElement("td");
            if (key === "MS_Link_To_Renew_Cert" && cert[key]) {
              const a = document.createElement("a");
              a.href = cert[key];
              a.innerText = "Renew";
              a.target = "_blank";
              td.appendChild(a);
            } else if (key === "ExpireDate" && cert[key]) {
              const date = new Date(cert[key]);
              td.innerText = date.toLocaleDateString();
            } else {
              td.innerText = cert[key] || "";
            }
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.innerHTML = `<h3>Certificates for ${employeeName}</h3>`;
        container.appendChild(table);
      } catch (err) {
        console.error("Failed to load certificates", err);
        container.innerHTML = "<p>Error loading certificate data.</p>";
      }
    }

    function switchTab(tab, tabs) {
      Object.entries(tabs).forEach(([name, div]) => {
        div.classList.toggle("active", name === tab);
      });
      document.querySelectorAll(".tab-button").forEach(btn => {
        btn.classList.toggle("active", btn.innerText === tab);
      });
    }

    document.addEventListener("DOMContentLoaded", loadTeamData);
  </script>
</body>
</html>
